AntiFeatures:
  - NonFreeNet
Categories:
  - Connectivity
  - Internet
  - Security
License: GPL-3.0-only
AuthorName: AmneziaVPN
AuthorEmail: support@amnezia.org
WebSite: https://amnezia.org/en
SourceCode: https://github.com/amnezia-vpn/amnezia-client
IssueTracker: https://github.com/amnezia-vpn/amnezia-client/issues
Changelog: https://github.com/amnezia-vpn/amnezia-client/releases
Donate: https://amnezia.org/en/about
Bitcoin: bc1qn9rhsffuxwnhcuuu4qzrwp4upkrq94xnh8r26u

AutoName: Amnezia VPN

RepoType: git
Repo: https://github.com/amnezia-vpn/amnezia-client.git

Builds:
  - versionName: 4.5.3.0
    versionCode: 52
    commit: 4.5.3.0
    subdir: deploy
    submodules: true
    sudo:
      - apt-get update
      - apt-get install -y ninja-build libgl1-mesa-dev libstdc++6 libncurses5
      - apt-get install -y 7zip build-essential make python-is-python3
      - apt-get remove -y openjdk-11-jdk-headless openjdk-11-jre-headless
      - apt-get install -y openjdk-17-jdk-headless openjdk-17-jre-headless
      - apt-get install -y -t bookworm-backports cmake
    output: deploy/build
    srclibs:
      - Qt5@v6.6.2
    scanignore:
      - client/3rd-prebuilt
      - client/3rd
    prebuild:
      - sdkmanager 'platforms;android-34' 'build-tools;34.0.0'
      - cd $$Qt5$$
      - ./init-repository -f --module-subset=qtbase,qtdeclarative,qtimageformats,qtmultimedia,qtshadertools,qtsvg,qttools,qttranslations,qtremoteobjects,qt5compat
    target: android-34
    build: 
      - |
        configure_and_build_qt() {
          local ABI=$1
          local ANDROID_ABI=android_${ABI}
          if [ "$ABI" = "arm64-v8a" ]; then
            ANDROID_ABI="android_arm64_v8"
          elif [ "$ABI" = "armeabi-v7a" ]; then
            ANDROID_ABI="android_armv7"
          fi
          export ABIS_BUILD_FILES=$QTPREFIX/build_${ANDROID_ABI}
          mkdir -p $ABIS_BUILD_FILES $QTPREFIX/${ANDROID_ABI}
          pushd ${ABIS_BUILD_FILES}
          $$Qt5$$/configure -platform android-clang --disable-rpath -opensource -confirm-license \
            -silent -prefix $QTPREFIX/$ANDROID_ABI -release -nomake tests -nomake examples -no-sql-mysql \
            -no-dbus -no-use-gold-linker -sysconfdir /etc/xdg -opengl es2 -android-sdk $$SDK$$ \
            -android-abis ${ABI} -android-ndk $$NDK$$ -android-ndk-platform android-34 \
            -skip qtcoap -skip qtopcua -skip qtwebengine -skip qt3d -skip qtlanguageserver \
            -skip qtdatavis3d -skip qtquick3d -skip qtwebview -skip qtactiveqt -skip qtquick3dphysics \
            -skip qtserialport -skip qtquicktimeline -skip qtspeech -skip qtwebchannel -skip qtscxml \
            -qt-host-path $QT_HOST_PREFIX \
            -no-feature-qml-jit \
            CMAKE_INSTALL_MESSAGE=NEVER
          cmake --build . --parallel
          cmake --install .
          popd
        }
        export ROOT_PATH=$(readlink -f ${PWD}/..)
        export JAVA_HOME=$(readlink -f /usr/bin/javac | sed "s:/bin/javac::")
        export ANDROID_SDK_ROOT=$$SDK$$ ANDROID_NDK_ROOT=$$NDK$$
        export ANDROID_API_VERSION=android-34
        export PATH=${JAVA_HOME}/bin:${PATH}
        export ANDROID_BUILD_PLATFORM=android-34
        export BUILD_DIR=$(readlink -f ${PWD})/android-build
        export QT_HOST_BUILD=$(readlink -f ${PWD}/../srclib)/build-host-qt
        export QT_HOST_PREFIX=$(readlink -f ${PWD}/../srclib)/qt/6.6.2/gcc_64
        export QT_BUILD=$(readlink -f ${PWD}/../srclib)/build-qt
        export QTPREFIX=$(readlink -f ${PWD}/../srclib)/qt/6.6.2
        rm -rf $QT_HOST_PREFIX $QT_HOST_BUILD $QTPREFIX $QT_BUILD
        mkdir -p $BUILD_DIR $QT_HOST_PREFIX $QT_HOST_BUILD $QTPREFIX $QT_BUILD
        pushd ${QT_HOST_BUILD}
        $$Qt5$$/configure -opensource -confirm-license -prefix $QT_HOST_PREFIX -release \
          -submodules qtbase,qttools,qtremoteobjects,qt5compat,qtshadertools,qtimageformats \
          -nomake tests -nomake examples -no-sql-mysql \
          -no-dbus -no-openssl -no-glib -no-icu -no-cups -no-fontconfig -no-gtk -no-egl \
          -skip qtsql -skip qtxml -skip qtprintsupport -skip qttestlib -skip qtwebengine -skip qtgamepad -skip qtwebchannel \
          -skip qtwebview -skip qtwebsockets -skip qtwebglplugin -skip qtserialport -skip qtnetworkauth -skip qt3d -skip qtsensors \
          -skip qtwayland -skip qtxmlpatterns -skip qtscxml -skip qtscript -skip qtconnectivity \
          -skip qtlanguageserver -skip qtquicktimeline -skip qtquick3d -skip qtactiveqt \
          -skip qtcoap -skip qtdatavis3d -skip qthttpserver -skip qtpositioning -skip qtdoc -skip qtgrpc -skip qtlocation -skip qtlottie \
          -skip qtmqtt -skip qtopcua -skip qtquick3dphysics -skip qtquickeffectmaker -skip qtserialbus -skip \
          qtspeech -skip qtvirtualkeyboard -no-opengl -no-feature-debug -no-feature-itemmodeltester \
          -no-feature-qml-jit -no-feature-concurrent -- -D CMAKE_INSTALL_MESSAGE=NEVER
        cmake --build . --parallel
        cmake --install .
        popd
        pushd ${QT_BUILD}
        for ABI in armeabi-v7a arm64-v8a x86 x86_64; do
          configure_and_build_qt $ABI
        done
        popd
        pushd ${ROOT_PATH}
        export QT_HOST_PATH=$QT_HOST_PREFIX
        COMPILER=cross-android QTBINARYDIR=$QT_HOST_PREFIX/bin deploy/build_android.sh \
          --apk all --build-platform $ANDROID_BUILD_PLATFORM --move
        popd
    ndk: r26b

AutoUpdateMode: Version
UpdateCheckMode: Tags
CurrentVersion: 4.5.3.0
CurrentVersionCode: 52
